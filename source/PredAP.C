#include "PredAP.h"
#include "TFile.h"
#include "TTree.h"
#include <cmath>

// Prediction Parameters...
static APParams apTable[160] = {
	// p0, p0err, p1, p1err, covp0p1, tau, tauerr 
/* 0 */ {0.46907, 0.670062, 0.000233615, 2.45456e-05, -1.42169e-05, 1386.21, 145.259},
  /* 1 */ {0.545742, 0.813113, 0.000263127, 4.85255e-05, -3.53732e-05, 1410.01, 154.655},
  /* 2 */ {0.468046, 0.656158, 0.000247159, 2.22166e-05, -1.25918e-05, 1416.22, 124.756},
  /* 3 */ {1.04262, 0.995759, 0.000257778, 5.58152e-05, -4.54102e-05, 1583.53, 147.267},
  /* 4 */ {1.50675, 0.99039, 0.000257249, 5.29309e-05, -4.69367e-05, 1376.21, 128.344},
  /* 5 */ {2.42385, 1.23324, 0.000231088, 7.6651e-05, -8.21661e-05, 1535.27, 153.573},
  /* 6 */ {1.30861, 0.779588, 0.000276022, 4.80173e-05, -2.91846e-05, 1326.16, 119.043},
  /* 7 */ {0.682319, 0.655174, 0.000273993, 5.51059e-05, -2.54048e-05, 1349.49, 124.635},
  /* 8 */ {1.03047, 0.826623, 0.000189171, 4.76831e-05, -3.15302e-05, 1651.43, 180.553},
  /* 9 */ {0.412899, 0.698427, 0.000200356, 3.31021e-05, -1.90181e-05, 1373.43, 113.115},
  /* 10 */ {1.87526, 0.931603, 0.000268283, 4.4535e-05, -3.75783e-05, 1436.68, 152.474},
  /* 11 */ {0.312816, 0.652234, 0.000197546, 3.42745e-05, -1.69501e-05, 1381.71, 117.176},
  /* 12 */ {0.639524, 0.667958, 0.000218388, 3.73075e-05, -1.89442e-05, 1493.57, 148.972},
  /* 13 */ {0.492705, 0.978001, 0.000229988, 4.9402e-05, -4.08919e-05, 1401.6, 128.123},
  /* 14 */ {0.0593832, 0.636701, 0.000182981, 2.42649e-05, -1.33774e-05, 1591.77, 153.301},
  /* 15 */ {0.581628, 0.726478, 0.00023406, 3.58991e-05, -2.03535e-05, 1264.41, 117.527},
  /* 16 */ {0.977836, 0.827803, 0.000203069, 3.85687e-05, -2.69154e-05, 1399.74, 136.595},
  /* 17 */ {0.313505, 0.697839, 0.000144994, 3.26597e-05, -1.8881e-05, 1441.1, 128.178},
  /* 18 */ {1.51422, 0.956277, 0.000344982, 7.88478e-05, -6.3931e-05, 1401.38, 160.68},
  /* 19 */ {0.432014, 0.920085, 0.00014914, 3.67204e-05, -3.06498e-05, 1376.4, 140.275},
  /* 20 */ {-0.00216429, 0.643629, 0.000238003, 2.77469e-05, -1.44405e-05, 1421.42, 123.508},
  /* 21 */ {0.265448, 0.764882, 0.000215158, 4.26837e-05, -2.56325e-05, 1632.63, 157.74},
  /* 22 */ {3.90338, 0.760105, 0.000182357, 3.13274e-05, -2.17592e-05, 1677.62, 203.991},
  /* 23 */ {0.452987, 0.643098, 0.000169735, 3.36379e-05, -1.69097e-05, 1517.41, 150.015},
  /* 24 */ {2.22167, 0.882024, 0.000162614, 3.82108e-05, -3.05296e-05, 1293.67, 106.949},
  /* 25 */ {-0.136836, 0.61515, 0.000184365, 3.64866e-05, -1.74312e-05, 1466.26, 120.752},
  /* 26 */ {-0.238535, 0.630815, 0.000223954, 3.53569e-05, -1.79362e-05, 1472.04, 127.828},
  /* 27 */ {-0.147784, 0.380148, 0.000170887, 2.31821e-05, -5.88824e-06, 1423.25, 120.643},
  /* 28 */ {-0.186604, 0.556962, 0.000271861, 3.52665e-05, -1.49191e-05, 1223.61, 121.883},
  /* 29 */ {1.11523, 1.16144, 0.000298478, 6.85201e-05, -6.50563e-05, 1719.82, 180.811},
  /* 30 */ {0.222862, 0.762944, 0.000273358, 3.2963e-05, -2.10085e-05, 1600.65, 177.118},
  /* 31 */ {0.481049, 0.581575, 0.000222069, 4.13801e-05, -1.91223e-05, 1472.5, 234.795},
  /* 32 */ {0.306113, 0.644607, 0.000275952, 3.64154e-05, -1.76478e-05, 1551.21, 162.494},
  /* 33 */ {0.28754, 0.540385, 0.000155855, 2.23387e-05, -1.01466e-05, 1963.07, 240.624},
  /* 34 */ {1.01947, 0.948382, 0.000287762, 6.78498e-05, -5.35684e-05, 1573.64, 150.041},
  /* 35 */ {0.0798381, 0.602398, 0.00017895, 3.67233e-05, -1.78376e-05, 1687.93, 171.861},
  /* 36 */ {0.0717578, 0.754618, 0.000242021, 4.94018e-05, -3.01376e-05, 1365.54, 140.591},
  /* 37 */ {0.784474, 0.797077, 0.000281168, 3.79453e-05, -2.74866e-05, 1332.84, 132.736},
  /* 38 */ {0.707538, 1.19721, 0.000272381, 8.48639e-05, -8.92856e-05, 1713.26, 211.98},
  /* 39 */ {0.32898, 1.06777, 0.000403248, 0.000103042, -8.63929e-05, 1326.43, 123.599},
  /* 40 */ {0.433426, 0.691158, 0.000270613, 4.79981e-05, -2.39289e-05, 1333.53, 129.122},
  /* 41 */ {-0.0436032, 0.552638, 0.000185713, 2.22489e-05, -1.0154e-05, 1418.97, 131.2},
  /* 42 */ {0.350773, 0.828584, 0.000232679, 4.45491e-05, -3.1027e-05, 1475.49, 130.764},
  /* 43 */ {1.83888, 1.16913, 0.000270468, 8.05056e-05, -7.87361e-05, 1231.99, 94.0611},
  /* 44 */ {0.267663, 0.485703, 0.000240366, 3.68802e-05, -1.15671e-05, 1413.97, 134.385},
  /* 45 */ {0.0952825, 0.638556, 0.000210039, 3.69201e-05, -1.81939e-05, 1391.57, 114.124},
  /* 46 */ {0.535279, 0.715902, 0.000207664, 3.67924e-05, -2.13051e-05, 1284.91, 121.107},
  /* 47 */ {2.07288, 0.99687, 0.000230672, 5.3828e-05, -4.46586e-05, 1459.79, 137.772},
  /* 48 */ {1.52646, 2.01021, 0.000251076, 0.000133831, -0.000248832, 1154.04, 173.976},
  /* 49 */ {0.223796, 0.562632, 0.000204643, 2.96946e-05, -1.20238e-05, 1435.63, 132.215},
  /* 50 */ {-1.44405, 1.14607, 0.000329831, 9.38999e-05, -0.000101177, 1490.52, 324.96},
  /* 51 */ {0.115885, 0.755279, 0.000214648, 4.11847e-05, -2.46879e-05, 1331.92, 124.37},
  /* 52 */ {-0.675888, 1.40221, 0.000534752, 0.000106204, -0.000142457, 1075.14, 229.43},
  /* 53 */ {0.220622, 0.624931, 8.94692e-05, 9.93224e-05, -4.82647e-05, 1286.69, 230.102},
  /* 54 */ {0.584403, 0.69011, 0.000221622, 2.61204e-05, -1.57023e-05, 1551.43, 165.223},
  /* 55 */ {0.365967, 0.788059, 0.000229022, 2.8584e-05, -1.929e-05, 1621.09, 160.76},
  /* 56 */ {0.216619, 0.695731, 0.000257071, 4.31278e-05, -2.30608e-05, 1689.9, 177.301},
  /* 57 */ {0.571603, 0.602983, 0.000221062, 2.44571e-05, -1.16223e-05, 1661.45, 151.946},
  /* 58 */ {0.294368, 0.809843, 0.000313627, 6.39636e-05, -3.98304e-05, 1419.23, 131.042},
  /* 59 */ {0.620959, 0.720896, 0.00022438, 3.73827e-05, -2.00771e-05, 1535.86, 157.596},
  /* 60 */ {-0.0838908, 0.44767, 0.000159641, 2.75912e-05, -8.75109e-06, 1586.55, 155.22},
  /* 61 */ {0.744193, 0.444741, 0.000217561, 3.27968e-05, -9.36296e-06, 1356.06, 99.0722},
  /* 62 */ {0.0653833, 0.755505, 0.000352228, 3.4198e-05, -2.33756e-05, 1595.2, 190.918},
  /* 63 */ {-0.20565, 0.918504, 0.000208075, 3.90458e-05, -3.31552e-05, 1176.77, 96.6131},
  /* 64 */ {0.658687, 0.683599, 0.000182949, 3.67058e-05, -2.00961e-05, 1317.41, 101.42},
  /* 65 */ {0.412035, 0.760352, 0.000251899, 5.33246e-05, -3.14206e-05, 1732.06, 191.75},
  /* 66 */ {0.740685, 0.633199, 0.00023809, 2.38817e-05, -1.33233e-05, 1545.74, 153.4},
  /* 67 */ {0.00494478, 0.536335, 0.000190915, 3.44787e-05, -1.40925e-05, 1665.45, 182.008},
  /* 68 */ {0.765326, 1.0001, 0.000263901, 6.44338e-05, -5.43615e-05, 1361.38, 128.634},
  /* 69 */ {0.225686, 0.626774, 0.000200134, 3.61987e-05, -1.75357e-05, 1424.03, 121.522},
  /* 70 */ {0.292163, 0.643207, 0.000184408, 3.20055e-05, -1.5587e-05, 1522.88, 130.918},
  /* 71 */ {0.437588, 0.59289, 0.000177344, 3.5862e-05, -1.57342e-05, 1781.69, 185.479},
  /* 72 */ {0.28619, 0.809471, 0.000265563, 4.59582e-05, -3.05293e-05, 1550.91, 166.292},
  /* 73 */ {0.800503, 0.694539, 0.000237389, 3.5006e-05, -2.10071e-05, 1449.77, 163.202},
  /* 74 */ {0.493343, 0.58281, 0.000229522, 2.05216e-05, -9.96544e-06, 1457.72, 141.545},
  /* 75 */ {0.594889, 0.788362, 0.000189041, 4.05728e-05, -2.5637e-05, 1549.59, 161.661},
  /* 76 */ {1.42146, 1.6137, 0.000389274, 0.000143747, -0.000197489, 1335.8, 126.174},
  /* 77 */ {0.276641, 0.516307, 0.00014739, 2.74797e-05, -1.12927e-05, 1399.24, 118.101},
  /* 78 */ {0.752552, 0.933529, 0.000304519, 5.57869e-05, -4.22071e-05, 1499.31, 155.124},
  /* 79 */ {0.51853, 1.05537, 0.000222025, 6.44611e-05, -5.74238e-05, 1583.53, 172.502},
  /* 80 */ {0.213926, 0.668821, 0.000165633, 3.41109e-05, -1.98492e-05, 1370.83, 126.12},
  /* 81 */ {0.489051, 0.696533, 0.000184574, 3.26743e-05, -1.92227e-05, 1380.45, 125.322},
  /* 82 */ {0.929568, 0.767288, 0.000206409, 2.94368e-05, -2.02812e-05, 1502.06, 168.974},
  /* 83 */ {2.13778, 0.861619, 0.000186827, 5.98317e-05, -4.74981e-05, 1370.92, 126.535},
  /* 84 */ {0.141143, 0.488972, 0.000244169, 2.73689e-05, -9.89907e-06, 1347.47, 142.874},
  /* 85 */ {0.140761, 0.572686, 0.000156849, 3.2358e-05, -1.4514e-05, 1582.44, 152.029},
  /* 86 */ {0.480282, 0.885751, 0.000235575, 4.61323e-05, -3.34785e-05, 1647.76, 184.172},
  /* 87 */ {0.723741, 0.746677, 0.000195941, 3.6364e-05, -2.19685e-05, 1352.69, 111.848},
  /* 88 */ {0.872092, 0.623516, 0.000207316, 2.93145e-05, -1.41757e-05, 1423.65, 117.94},
  /* 89 */ {1.06595, 1.0955, 0.000312873, 6.41274e-05, -5.99663e-05, 1333.16, 107.903},
  /* 90 */ {0.231362, 0.676815, 0.000204462, 3.82652e-05, -2.00232e-05, 1470.85, 122.241},
  /* 91 */ {0.488452, 0.693789, 0.000160182, 3.96924e-05, -2.25073e-05, 1529.51, 142.501},
  /* 92 */ {0.0725658, 0.746865, 0.000238978, 4.20498e-05, -2.4581e-05, 1583.24, 133.766},
  /* 93 */ {0.442055, 0.961642, 0.000315391, 6.79812e-05, -5.27683e-05, 1463.42, 140.522},
  /* 94 */ {0.0342019, 0.599017, 0.000233866, 3.5003e-05, -1.5369e-05, 1393.34, 129.44},
  /* 95 */ {1.21096, 0.953833, 0.000243523, 5.65497e-05, -4.60164e-05, 1437.03, 155.243},
  /* 96 */ {1.27713, 1.05379, 0.000259846, 5.15706e-05, -4.80004e-05, 1369.01, 126.845},
  /* 97 */ {0.140774, 0.671268, 0.00018677, 3.82565e-05, -2.06281e-05, 1667.23, 160.638},
  /* 98 */ {1.34532, 1.07038, 0.000267148, 6.58368e-05, -6.06434e-05, 1695.55, 198.665},
  /* 99 */ {1.56001, 0.779038, 0.000177884, 2.51505e-05, -1.75819e-05, 1614.88, 186.29},
  /* 100 */ {0.838123, 0.76432, 0.00020425, 4.43728e-05, -2.64072e-05, 1545.21, 150.521},
  /* 101 */ {0.700109, 0.746573, 0.000225518, 2.5815e-05, -1.73626e-05, 1594.4, 139.818},
  /* 102 */ {0.10687, 0.725111, 0.000193026, 2.63139e-05, -1.7519e-05, 1508.52, 146.236},
  /* 103 */ {0.1919, 0.743644, 0.00022983, 3.90119e-05, -2.41233e-05, 1515.59, 155.125},
  /* 104 */ {0.776394, 0.50551, 0.00023863, 3.9451e-05, -1.39499e-05, 1249.43, 102.954},
  /* 105 */ {0.248335, 0.766109, 0.000218807, 4.82568e-05, -2.86912e-05, 1569.33, 147.739},
  /* 106 */ {2.78544, 1.5023, 0.00023252, 6.64189e-05, -9.56696e-05, 1339.57, 136.58},
  /* 107 */ {0.502757, 0.541135, 0.000183937, 1.89306e-05, -9.01928e-06, 1374.25, 137.375},
  /* 108 */ {0.111377, 0.968339, 0.000380466, 6.81145e-05, -5.2321e-05, 1870.6, 247.918},
  /* 109 */ {0.768658, 0.867875, 0.000246031, 4.6335e-05, -3.24571e-05, 1286.77, 108.596},
  /* 110 */ {1.73736, 0.752802, 0.000147843, 2.72794e-05, -1.81441e-05, 1362.47, 124.978},
  /* 111 */ {-0.410415, 0.512961, 0.000198157, 2.59016e-05, -1.04189e-05, 1558.96, 173.071},
  /* 112 */ {1.08196, 0.810043, 0.000275895, 6.32236e-05, -3.97683e-05, 1368.59, 140.171},
  /* 113 */ {1.14682, 0.700389, 0.000240519, 2.59273e-05, -1.58018e-05, 1494.43, 159.877},
  /* 114 */ {0.79512, 0.609058, 0.000180814, 2.69045e-05, -1.28766e-05, 1472.6, 136.824},
  /* 115 */ {0.995446, 0.752783, 0.000218663, 4.49367e-05, -2.80437e-05, 1381.42, 132.719},
  /* 116 */ {-0.254907, 0.662702, 0.00026092, 2.5667e-05, -1.40691e-05, 1520.78, 145.999},
  /* 117 */ {0.120369, 0.685832, 0.000172985, 3.28167e-05, -1.82603e-05, 1402.47, 131.846},
  /* 118 */ {0.73741, 0.798235, 0.000270489, 7.42339e-05, -4.41044e-05, 1467.18, 153.105},
  /* 119 */ {0.527785, 1.06362, 0.000339156, 5.99509e-05, -5.30384e-05, 1420.79, 143.765},
  /* 120 */ {0.893558, 0.781665, 0.000202551, 4.2121e-05, -2.83732e-05, 1374.13, 116.708},
  /* 121 */ {0.558615, 0.612056, 0.000266918, 3.58648e-05, -1.58091e-05, 1391.05, 119.882},
  /* 122 */ {1.19395, 0.729039, 0.000153089, 2.35506e-05, -1.52058e-05, 1362.81, 112.398},
  /* 123 */ {0.532046, 0.87333, 0.000316707, 6.499e-05, -4.28637e-05, 1426.01, 129.719},
  /* 124 */ {1.3188, 0.741053, 0.00020717, 4.06875e-05, -2.33938e-05, 1353.47, 118.023},
  /* 125 */ {0.458625, 0.491453, 0.000179245, 2.94013e-05, -9.90505e-06, 1218.49, 101.087},
  /* 126 */ {0.138636, 0.693061, 0.000216296, 2.36959e-05, -1.42655e-05, 1304.72, 120.12},
  /* 127 */ {0.353776, 1.01834, 0.000271626, 6.04118e-05, -5.02508e-05, 1361.07, 114.869},
  /* 128 */ {0.472173, 0.579957, 0.000270735, 3.39851e-05, -1.52883e-05, 1321.09, 119.944},
  /* 129 */ {0.339277, 0.741679, 0.0003405, 5.7625e-05, -3.15886e-05, 1725.17, 166.735},
  /* 130 */ {0.0520507, 0.608786, 0.000250495, 3.98657e-05, -1.76895e-05, 1392.99, 138.351},
  /* 131 */ {1.02794, 0.912564, 0.000239535, 4.13179e-05, -3.32118e-05, 1722.54, 190.734},
  /* 132 */ {0.0669271, 0.683685, 0.000329315, 3.15887e-05, -1.90301e-05, 1452.86, 154.185},
  /* 133 */ {0.0959656, 0.439363, 9.55802e-05, 2.55567e-05, -8.43157e-06, 1435.04, 145.179},
  /* 134 */ {0.662474, 0.840548, 0.000290484, 5.99467e-05, -3.73358e-05, 1353.24, 128.766},
  /* 135 */ {-0.0160799, 0.505891, 0.000167974, 3.24466e-05, -1.15161e-05, 1646.97, 151.053},
  /* 136 */ {1.02537, 1.07593, 0.000280255, 6.22718e-05, -5.62467e-05, 1354.26, 114.439},
  /* 137 */ {0.579653, 0.465906, 0.000223436, 2.71773e-05, -8.3336e-06, 1546.29, 157.993},
  /* 138 */ {-0.135189, 0.622748, 0.000233521, 3.39442e-05, -1.71449e-05, 1328.17, 116.523},
  /* 139 */ {1.82339, 1.84933, 0.000299079, 0.00010805, -0.000185877, 1558.87, 189.361},
  /* 140 */ {0.0857374, 0.659898, 0.00024533, 3.74669e-05, -2.00589e-05, 1571.22, 168.021},
  /* 141 */ {0.304441, 0.620202, 0.000198454, 4.84078e-05, -2.35464e-05, 1387.47, 144.955},
  /* 142 */ {0.0219118, 0.59237, 0.000291045, 2.30194e-05, -1.12374e-05, 1335.65, 111.543},
  /* 143 */ {1.31841, 0.973188, 0.000218317, 8.38673e-05, -6.39695e-05, 1366.81, 155.155},
  /* 144 */ {0.391455, 0.620723, 0.000218894, 3.80643e-05, -1.66966e-05, 1635.49, 157.645},
  /* 145 */ {0.487254, 0.978664, 0.000259846, 5.8206e-05, -4.6849e-05, 1417.02, 131.032},
  /* 146 */ {0.0230514, 0.659345, 0.000165436, 3.33294e-05, -1.7819e-05, 1452.84, 123.464},
  /* 147 */ {0.237391, 0.525154, 0.000194986, 2.3416e-05, -9.30168e-06, 1408.98, 107.367},
  /* 148 */ {0.958096, 0.71508, 0.000212373, 4.59709e-05, -2.42347e-05, 1376.04, 134.351},
  /* 149 */ {2.01745, 0.738492, 0.00014304, 2.36019e-05, -1.62591e-05, 1318.33, 106.248},
  /* 150 */ {0.840111, 1.09572, 0.000332976, 8.48175e-05, -8.03101e-05, 1225.4, 116.183},
  /* 151 */ {0.397574, 0.574429, 0.000193914, 3.49835e-05, -1.38877e-05, 1627.02, 143.255},
  /* 152 */ {0.808245, 1.23554, 0.000399544, 0.000106997, -0.000107082, 1298.13, 113.692},
  /* 153 */ {0.243697, 0.806932, 0.000178047, 4.55666e-05, -3.07225e-05, 1287.01, 104.726},
  /* 154 */ {1.03886, 1.29812, 0.000353896, 9.91526e-05, -0.000109694, 1405.66, 132.125},
  /* 155 */ {0.915944, 0.843717, 0.00023821, 4.21316e-05, -2.99032e-05, 1347.72, 110.152},
  /* 156 */ {0.730734, 0.764641, 0.00020268, 3.88911e-05, -2.31223e-05, 1469.31, 123.239},
  /* 157 */ {0.54013, 0.627225, 0.000179733, 3.86171e-05, -2.02546e-05, 1213.71, 107.903},
  /* 158 */ {0.638792, 1.0091, 0.000345088, 7.25732e-05, -5.79546e-05, 1360.07, 129.687},
  /* 159 */ {0.93102, 0.66851, 0.000135518, 2.58306e-05, -1.4976e-05, 1584.32, 160.382},
};

// Calculate predicted afterpulses during initPredTime~finalPredTime
SUBMETAPPred PredAP(int module = 0, double areaLP = 10000, double timeLP = 550,
                  double initPredTime = 1150, double finalPredTime = 4096)
{
    SUBMETAPPred out;
    APParams p = apTable[module];

    double p0 = p.p0;
    double p0err = p.p0err;
    double p1 = p.p1;
    double p1err = p.p1err;
    double cov = p.covp0p1;
	double tau = p.tau;
	double tauerr = p.tauerr;
	
	double dt = initPredTime - timeLP;
	if ( dt < 600 ) { std::cerr << "Warning : Recommended initial prediction time must be greater than 600 TDC" << std::endl; }

	double t0 = 720;
	double t1 = 3475.2;
	double ti = initPredTime * 1.2;
	double tf = finalPredTime * 1.2;

	double exp0 = exp( - t0 / tau );
	double exp1 = exp( - t1 /tau );
	double expi = exp( - ti / tau );
	double expf = exp( - tf / tau );
	double predap = (p0 + p1 * areaLP) * (expi - expf) / (exp0 - exp1);

	double fA = (p0 + p1 * areaLP * 1.2 * 0.28);
	double norm = exp0 - exp1;

	double fAerr = sqrt(pow(p0err , 2) + pow((1.2 * 0.28 * areaLP * p1err), 2) + 2 * 0.28 * 1.2 * areaLP *cov);
	double normerr = tauerr * ((ti * expi - tf * expf)*(exp0 - exp1) - (expi - expf)*(t0 * exp0 - t1 * exp1)) / pow(tau*(exp0 - exp1), 2);
	double prederr = predap * sqrt(pow(fAerr / fA ,2) + pow(normerr / ((expi - expf)/norm), 2));

	out.value = predap;
    out.error = prederr;

    return out;
}
